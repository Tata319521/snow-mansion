<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é›ªä¸­æ´‹æˆ¿ï¼šç§˜å¯†æˆ¿é—´è°ƒæŸ¥</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#151c36;
      --card:rgba(15,23,48,.78);
      --stroke:rgba(60,76,130,.55);
      --text:#e9eeff;
      --muted:#b9c2ff;
      --accent:#7cf3ff;
      --accent2:#ff7ad9;
      --good:#65ff9a;
      --bad:#ff6b6b;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,243,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,122,217,.14), transparent 60%),
        radial-gradient(900px 600px at 50% 100%, rgba(101,255,154,.10), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .wrap{width:min(1100px, 100%); position:relative;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:14px; opacity:.92; font-size:13px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      border:1px solid rgba(124,243,255,.25);
      background:rgba(15,23,48,.55);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
    }
    .dot{width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 18px rgba(124,243,255,.45);}
    .small{color:var(--muted)}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    header{padding:20px 22px 14px;border-bottom:1px solid rgba(60,76,130,.45);}
    header h1{margin:0 0 8px;font-size:20px;letter-spacing:.5px}
    header p{margin:0;color:var(--muted);line-height:1.6}
    .progress{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px;margin-top:10px;}
    .bar{flex:1;height:8px;border-radius:999px;background:rgba(60,76,130,.45);overflow:hidden;}
    .bar>i{display:block;height:100%;width:0%;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      border-radius:999px;transition:width .25s ease;}
    main{padding:18px 22px 22px;}
    .layout{display:grid;gap:14px;grid-template-columns: 1.35fr .65fr;}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr;} }

    .panel{
      border:1px solid rgba(60,76,130,.45);
      background:rgba(8,12,26,.35);
      border-radius:14px;
      padding:14px;
    }
    .panel h3{margin:0 0 8px;font-size:14px;color:var(--muted);font-weight:700;letter-spacing:.3px}
    .mono{font-family:var(--mono);font-size:12.8px;color:#d7ddff;white-space:pre-wrap;line-height:1.55}
    .hint{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.7}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{
      border:1px solid rgba(124,243,255,.35);
      background: linear-gradient(135deg, rgba(124,243,255,.18), rgba(255,122,217,.12));
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      transition:.15s ease;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    button:hover{transform: translateY(-1px);}
    button.secondary{
      border-color: rgba(60,76,130,.55);
      background: rgba(15,23,48,.35);
      color: var(--muted);
      box-shadow:none;
      font-weight:650;
    }
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .field{display:grid;gap:8px;margin: 8px 0;}
    input[type="text"], input[type="password"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(60,76,130,.55);
      background: rgba(0,0,0,.16);
      color:var(--text);
      outline:none;
      font-family:var(--sans);
      font-size:14px;
    }
    input::placeholder{color: rgba(185,194,255,.7)}
    input[readonly]{opacity:.95; cursor:not-allowed;}

    .roomTitle{font-size:16px;font-weight:800;margin:0 0 6px;}
    .grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      margin-top:12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .item{
      border:1px solid rgba(60,76,130,.45);
      background: rgba(15,23,48,.28);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      transition:.15s ease;
      min-height:70px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .item:hover{transform: translateY(-1px); border-color: rgba(124,243,255,.32);}
    .icon{width:26px;height:26px;border-radius:10px;display:grid;place-items:center;
      background:rgba(124,243,255,.12);border:1px solid rgba(124,243,255,.22);flex:0 0 auto;}
    .item b{display:block;font-size:13.5px}
    .item .meta{color:var(--muted);font-size:12.2px;line-height:1.5;margin-top:2px}
    .tag{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(60,76,130,.5);
      color:var(--muted);
      background:rgba(15,23,48,.22);
      margin-top:6px;
    }

    .msg{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px dashed rgba(124,243,255,.35);
      background: rgba(15,23,48,.25);
      color: var(--text);
      display:none;
    }
    .msg.show{display:block;}
    .msg.good{border-color: rgba(101,255,154,.45)}
    .msg.bad{border-color: rgba(255,107,107,.45)}

    .inv{
      display:grid; gap:10px;
    }
    .invItem{
      border:1px solid rgba(60,76,130,.45);
      background: rgba(15,23,48,.25);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition:.15s ease;
    }
    .invItem:hover{transform:translateY(-1px);border-color:rgba(124,243,255,.32)}
    .invItem b{font-size:13px}
    .invItem .meta{color:var(--muted);font-size:12px;line-height:1.5;margin-top:2px}

    /* modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modalMask.show{display:flex;}
    .modal{
      width:min(760px, 100%);
      background: rgba(12,18,40,.92);
      border:1px solid rgba(124,243,255,.22);
      border-radius: 18px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(60,76,130,.45);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .modalHead b{font-size:14px}
    .closeBtn{
      border:1px solid rgba(60,76,130,.55);
      background: rgba(15,23,48,.32);
      color: var(--muted);
      padding:8px 10px;
      border-radius: 12px;
      box-shadow:none;
      font-weight:700;
    }
    .modalBody{padding:14px 16px;}
    .modalBody .mono{font-size:13px}
    .modalActions{padding:14px 16px;border-top:1px solid rgba(60,76,130,.45);display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .kbd{
      font-family: var(--mono);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(60,76,130,.55);
      background: rgba(15,23,48,.25);
      color:#d7ddff;
      font-size:12px;
    }

    /* confetti */
    .confetti{
      pointer-events:none;
      position:absolute; inset:-12px -12px -12px -12px;
      overflow:hidden;
      display:none;
    }
    .confetti.show{display:block;}
    .confetti span{
      position:absolute;
      top:-20px;
      font-size:18px;
      opacity:.95;
      animation: fall linear forwards;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(360deg); opacity: .95; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="confetti" id="confetti"></div>

  <div class="topbar">
    <div class="badge">
      <span class="dot"></span>
      <div>
        <div style="font-weight:800;">é›ªä¸­æ´‹æˆ¿ Â· ç§˜å¯†æˆ¿é—´è°ƒæŸ¥</div>
        <div class="small">è¿™é‡Œä¼¼ä¹å¾ˆæ¸©æš–...</div>
      </div>
    </div>
    <div class="small">è¿›åº¦ï¼š<span id="progressText">0%</span></div>
  </div>

  <div class="card">
    <header>
      <h1 id="gameTitle">æš´é›ªä¸­ï¼Œä¸€åº§å·¨å¤§çš„å»ºç­‘é™é™çš„çŸ—ç«‹åœ¨ä½ é¢å‰ï¼Œè€Œä½ å¾¡å¯’çš„åªæœ‰æ€€é‡Œçš„...é¥ºå­?</h1>
      <p id="gameSubtitle">ä½ åœ¨è¢«å†»æˆå†°å—å‰å‘ç°äº†è¿™ä¸ªæ²‰é»˜çš„æˆ¿å­ï¼Œå®ƒä»é›ªå¹•æ·±å¤„æµ®å‡ºæ¥ï¼Œåƒä¸€å¤´ææµ…çš„å·¨é²¸éª¨æ¶ï¼Œå°–é¡¶åˆºè¿›ä½å‹çš„äº‘å±‚ã€‚ä½†ä½ ç®¡ä¸äº†è¿™äº›äº†ï¼Œæ¸©æš–çš„çƒ›ç«åœ¨çª—å£å¸å¼•ç€ä½ ã€‚</p>
      <div class="progress">
        <div class="bar"><i id="barFill"></i></div>
        <span class="small" id="barLabel">å‡†å¤‡ä¸­â€¦</span>
      </div>
    </header>

    <main>
      <div class="layout">
        <!-- LEFT -->
        <section class="panel">
          <h3>å½“å‰æˆ¿é—´</h3>
          <div class="mono">
            <div class="roomTitle" id="roomName"></div>
            <div id="roomDesc"></div>
          </div>

          <div class="grid" id="itemsGrid"></div>

          <div class="msg" id="mainMsg"></div>
          <div class="actions">
            <button id="btnNew">æ–°å¼€ä¸€å±€</button>
          </div>
          <div class="hint" id="hintBox"></div>
        </section>

        <!-- RIGHT -->
        <aside class="panel">
          <h3>è°ƒæŸ¥å‘˜ä¿¡æ¯</h3>
          <div class="field">
            <input id="playerName" type="text" placeholder="è°ƒæŸ¥å‘˜ä»£å·" maxlength="18" readonly />
            <div class="hint">æ¥åˆ°è¿™é‡Œæ˜¯æ­£ç¡®çš„é€‰æ‹©å—ï¼Ÿ</div>
          </div>

          <div style="height:10px"></div>

          <h3>èƒŒåŒ…</h3>
          <div class="inv" id="invList"></div>

          <div style="height:10px"></div>

          <h3>è°ƒæŸ¥æ—¥å¿—</h3>
          <div class="mono" id="logBox" style="max-height:260px;overflow:auto;"></div>
        </aside>
      </div>
    </main>
  </div>
</div>

<!-- Modal -->
<div class="modalMask" id="modalMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <b id="modalTitle">...</b>
      <button class="closeBtn" id="modalClose">å…³é—­</button>
    </div>
    <div class="modalBody">
      <div class="mono" id="modalBody"></div>
      <div class="field" id="modalInputWrap" style="display:none;margin-top:12px;">
        <input id="modalInput" type="password" maxlength="8" placeholder="åœ¨æ­¤è¾“å…¥â€¦" />
        <div class="hint" id="modalInputHint"></div>
      </div>
    </div>
    <div class="modalActions" id="modalActions"></div>
  </div>
</div>

<script>
/**
 * =======================
 * ä½ åªéœ€è¦æ”¹è¿™é‡Œï¼šCONFIG
 * =======================
 */
const CONFIG = {
  title: "é›ªä¸­æ´‹æˆ¿ï¼šç§˜å¯†æˆ¿é—´è°ƒæŸ¥",
  subtitle: "ä½ åœ¨è¢«å†»æˆå†°å—å‰å‘ç°äº†è¿™ä¸ªæ²‰é»˜çš„æˆ¿å­ï¼Œå®ƒä»é›ªå¹•æ·±å¤„æµ®å‡ºæ¥ï¼Œåƒä¸€å¤´ææµ…çš„å·¨é²¸éª¨æ¶ï¼Œå°–é¡¶åˆºè¿›ä½å‹çš„äº‘å±‚ã€‚ä½†ä½ ç®¡ä¸äº†è¿™äº›äº†ï¼Œæ¸©æš–çš„çƒ›ç«åœ¨çª—å£å¸å¼•ç€ä½ ã€‚",
  defaultPlayer: "è°ƒæŸ¥å‘˜",
  defaultFriend: "å¥¹",
  birthdayDateText: "12æœˆ18æ—¥",
  examDateText: "12æœˆ20æ—¥ã€12æœˆ21æ—¥",
  lockboxCode: "1218",
  key1Shape: "å®ƒèººåœ¨ç¢ç“·ä¸å°˜ç°é‡Œã€‚ä½ æèµ·å®ƒï¼ŒæŒ‡å°–å…ˆè¢«ä¸€é˜µé›ªä¸€æ ·çš„å†°å†·å’¬ä½ã€‚é’¥åŒ™é€šä½“é“¶ç™½ã€ç»†é•¿ï¼Œé‡‘å±è¡¨é¢æœ‰ç»†å¯†æ‹‰ä¸çº¹è·¯ï¼Œåƒè¢«é£é›ªåå¤ç£¨è¿‡ã€‚é’¥åŒ™å¤´æ˜¯é•‚ç©ºé›ªèŠ±ï¼Œå…­ç“£å¯¹ç§°ï¼Œè¾¹ç¼˜å¾®åˆ©ï¼Œå†…ä¾§åˆ»ç€å‡ é“å‡ ä¹çœ‹ä¸è§çš„åˆ»çº¿ã€‚",
  key2Shape: "å®ƒå‘ˆæ¸©æš–çš„é‡‘è‰²ï¼Œè¡¨é¢ä¸æ˜¯é•œé¢ï¼Œè€Œå¸¦ç€å¾®å¾®çš„é›¾é¢å…‰æ³½ï¼›é’¥åŒ™æŸ„æ˜¯åœ†å¤´ï¼Œè¾¹ç¼˜åšæˆæœˆæ¡‚å¶çš„æµ®é›•ï¼Œæ‘¸ä¸Šå»æœ‰ç»†å°çš„èµ·ä¼ï¼Œåƒä¸€åœˆæ‚„æ‚„åŠ å†•çš„å† ã€‚",
  cutsceneToBirthday: [
  "ä½ æŠŠé’¥åŒ™æ’è¿›é”å­”ã€‚é‡‘å±æ‘©æ“¦å£°å¾ˆæ¸…æ¥šã€‚é—¨ç¼é‡Œé€å‡ºä¸€çº¿å†·å…‰ï¼Œç©ºæ°”é‡Œæœ‰ä¸€è‚¡æ·¡æ·¡çš„èœ¡å‘³ã€‚ä½ åˆšè¦æ¨é—¨ï¼Œèº«åèµ°å»Šä¼ æ¥ä¸¤ä¸‹å¾ˆè½»çš„è„šæ­¥å£°ï¼Œéšå³åˆå®‰é™ä¸‹æ¥ã€‚",
  "é—¨é”â€œå’”â€åœ°ä¸€å£°å¼¹å¼€ã€‚ä¸‹ä¸€ç§’ï¼Œå¢™é‡Œä¼ æ¥è¿ç»­çš„æœºæ¢°éœ‡åŠ¨ï¼Œåƒé½¿è½®åœ¨å¿«é€Ÿå•®åˆã€‚åœ°æ¿è½»å¾®å‘é¢¤ï¼ŒåŠç¯æ™ƒäº†ä¸€ä¸‹ï¼Œç¯å…‰å¿½æ˜å¿½æš—ã€‚ä½ å¬è§æŸå¤„æœ‰ä¸œè¥¿æ»‘åŠ¨ï¼Œåƒæš—é—¨åœ¨ç§»åŠ¨ã€‚",
  "ä½ åˆšè¿ˆè¿›é—¨æ§›ï¼ŒèƒŒåçªç„¶æœ‰äººé è¿‘ã€‚éº»è¢‹ä»å¤´é¡¶å¥—ä¸‹ï¼Œå¸ƒæ–™ç²—ç³™ï¼Œå¸¦ç€ç°å°˜å‘³ã€‚æœ‰äººæŒ‰ä½ä½ çš„è‚©è†€å’Œæ‰‹è…•ï¼Œä½ æ¥ä¸åŠæŒ£æ‰ï¼Œåé¢ˆä¸€é˜µé’ç—›ï¼Œæ„è¯†è¿…é€Ÿå˜å¾—æ¨¡ç³Šã€‚",
  "ä½ é†’æ¥æ—¶ååœ¨ä¸€æŠŠæ¤…å­ä¸Šï¼Œæ‰‹è…•è¢«ç»‘åœ¨æ‰¶æ‰‹ä¸Šï¼Œç»³ç»“å¾ˆç´§ã€‚æˆ¿é—´é‡Œå¼€ç€ä¸€ç›æ˜é»„çš„ç¯ï¼Œå¢™è§’è´´ç€å½©å¸¦å’Œæ°”çƒï¼Œåœ°ä¸Šæ•£ç€å½©çº¸ã€‚ç©ºæ°”é‡Œæœ‰å¥¶æ²¹å’Œèœ¡çƒ›çš„å‘³é“ï¼Œä½†ç°åœºå®‰é™å¾—ä¸è‡ªç„¶ã€‚",
  "é—¨è¢«çŒ›åœ°æ¨å¼€ï¼Œå‡ ä¸ªäººèµ°è¿›æ¥ï¼Œæˆ´ç€é¢ç½©æˆ–å›´å·¾ï¼Œå£°éŸ³æ•…æ„å‹ä½ã€‚æœ‰äººè¯´ï¼š\"åˆ«ä¹±åŠ¨ã€‚\" å¦ä¸€ä¸ªäººé è¿‘ä½ ï¼Œæ•²äº†æ•²æ¤…èƒŒï¼š\"ä½ ä»Šå¤©è¦é…åˆä¸€ä¸‹ã€‚\" ä»–ä»¬å›´æˆåŠåœˆï¼Œåƒæ˜¯åœ¨ç­‰ä½ ååº”ã€‚",
  "ç¯å¿½ç„¶å…¨äº®ã€‚æœ‰äººå…ˆç¬‘å‡ºå£°ï¼Œæ‘˜ä¸‹é¢ç½©ï¼Œå…¶ä»–äººä¹Ÿè·Ÿç€æ‘˜ä¸‹æ¥ã€‚æœ‰äººæŠŠç»³å­è§£å¼€ï¼Œæ‹äº†æ‹ä½ çš„è‚©è†€ã€‚æ¡Œä¸Šè¢«æ¨å‡ºä¸€ä¸ªè›‹ç³•ï¼Œèœ¡çƒ›ç‚¹èµ·æ¥ã€‚å¤§å®¶ä¸€èµ·è¯´ï¼š\"ç”Ÿæ—¥å¿«ä¹ï¼\""
],

  birthdayBlessing: (friendName)=>(
`ğŸ‚ç”Ÿæ—¥å¿«ä¹ï¼
è¿™é‡Œæ˜¯æ—¥æ­Œï¼è™½ç„¶åšçš„å¾ˆä¸å®Œç¾å¾ˆè‰ç‡å•Šå•Šå•Šæ€»ä¹‹ç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼æƒ³ä¸åˆ°åœ¨è¿™é‡Œè·³ç¥ç¦å§å“¦å˜»å˜»å˜»ã€‚è€ƒç ”é¡ºåˆ©ï¼ç¥çœ‹åˆ°è¿™é‡Œå‡†å¤‡è€ƒç ”çš„åŒå­¦ä¹Ÿè€ƒç ”æˆåŠŸï¼å“¼å“¼ã€‚æ±‚è€ƒå®Œå‡ºæ¥èšé¤ã€‚`
  ),
  examBlessing: (friendName)=>(
`ğŸ“šçœ‹é“è¿™é‡Œè¦è€ƒç ”çš„æœ‹å‹ä»¬è€ƒç ”åŠ æ²¹ï¼
ä¸»æ’­ä»¬ä¸è¦ç»™è‡ªå·±å¤ªå¤§å‹åŠ›ï¼Œå°½åŠ›å°±å¥½ï¼Œwzféƒ½åœ¨ç¥ç¦ä½ ä»¬...!
è€å’©ç¾Šæˆ‘ä»¬å–œæ¬¢ä½ å‘€å–œæ¬¢ä½ ï¼ˆåŸå”±ï¼‰
ğŸŒŸ æœ€åç¥å¤§å®¶ï¼šæ€è·¯æ¸…æ™°ã€ç¬”ä¸‹ç”ŸèŠ±ã€å‘æŒ¥è¶…å¸¸ã€é¡ºåˆ©ä¸Šå²¸ï¼`
  ),
  hints: {
    hall: "æç¤ºï¼šå¾ˆå¤šå®¶å…·éƒ½èƒ½ç‚¹ã€‚",
    birthday: "æç¤ºï¼šè¿™é‡Œæ˜¯â€œç”Ÿæ—¥å¿«ä¹æˆ¿é—´â€ã€‚å‰§æƒ…ä¼šæ¨è¿›åˆ°ä½ æ‹¿åˆ°ç¬¬äºŒæŠŠé’¥åŒ™ã€‚",
    exam: "æç¤ºï¼šè¿™é‡Œæ˜¯â€œè€ƒç ”èƒœåˆ©æˆ¿é—´â€ã€‚ä½ å¯ä»¥æŠŠç¥ç¦å¤åˆ¶å‘ç»™å¥¹ã€‚",
  },
  rooms: {
    hall: {
      name: "é›ªä¸­æ´‹æˆ¿ Â· ä¸€å±‚å¤§å…",
      desc: "ä¸€å±‚å¤§å…å¾ˆå†·ï¼Œç©ºæ°”é‡Œå¸¦ç€æ½®æ¹¿çš„æœ¨å¤´å‘³å’Œä¸€ç‚¹èœ¡çƒ›æ®‹çƒŸçš„æ°”å‘³ã€‚çª—æ¡†ç»“éœœï¼Œç»ç’ƒå¤–æ˜¯åšé›ªå’Œæ¨¡ç³Šçš„æ ‘å½±ï¼Œé£ä»ç¼éš™é‡Œé’»è¿›æ¥ï¼Œæ—¶ä¸æ—¶å¸¦èµ·ä¸€é˜µè½»å“ã€‚åœ°æ¿æ˜¯æ·±è‰²æœ¨çº¹ï¼Œé è¿‘é—¨å£çš„ä½ç½®æœ‰å‡ é“è¢«æ‹–æ‹½è¿‡çš„æµ…ç—•ã€‚\n\nå¢™ä¸ŠæŒ‚ç€ä¸€åªè€å¼æŒ‚é’Ÿï¼Œé’Ÿæ‘†è¿˜åœ¨ç¼“æ…¢æ‘†åŠ¨ï¼Œç§’é’ˆå£°åœ¨å®‰é™æ—¶æ ¼å¤–æ¸…æ¥šã€‚å®¶å…·æ‘†å¾—æ•´é½å´ä¸è‡ªç„¶ï¼šæ—§æ²™å‘ã€ä¹¦æ¶ã€å£ç‚‰ã€è§’è½çš„èŠ±ç“¶éƒ½åƒè¢«äººåˆ»æ„æ”¾åœ¨è¯¥åœ¨çš„ä½ç½®ã€‚åœ°æ¯¯è¾¹ç¼˜ç¿˜èµ·ä¸€ç‚¹ï¼ŒæŸœå­æŠ½å±‰çš„ç¼é‡Œå¡ç€æœ¨å±‘ï¼Œå¢™ä¸Šçš„æŒ‚ç”»å¾®å¾®æ­ªæ–œã€‚\n\nä½ çš„ç›®æ ‡ï¼šæ‰¾åˆ°ç¬¬ä¸€æŠŠé’¥åŒ™ã€‚",
    },
    birthday: {
      name: "ç§˜å¯†æˆ¿é—´ Â· ç”Ÿæ—¥å¿«ä¹ï¼",
      desc: "æˆ¿é—´ä¸å¤§ï¼Œç¯å…‰åæš—ï¼Œåªæœ‰ä¸€ç›æš–é»„çš„å°ç¯äº®ç€ï¼Œè§’è½è¿˜æœ‰å‡ ç›æ²¡ç‚¹ç‡ƒçš„èœ¡çƒ›ã€‚å¢™ä¸Šè´´ç€å½©å¸¦å’Œæ°”çƒï¼Œæ¡Œä¸Šæ‘†ç€çº¸å¸½ã€å½©çº¸å’Œä¸€å¼ å†™äº†ä¸€åŠçš„å¡ç‰‡ï¼Œä½†æ‘†æ”¾å¾—è¿‡äºæ•´é½ï¼Œåƒä¸´æ—¶å¸ƒç½®åˆåˆ»æ„éšè—ã€‚ä½ ååœ¨æ¤…å­ä¸Šï¼Œæ‰‹è…•è¢«ç»‘åœ¨æ‰¶æ‰‹ä¸Šï¼Œç»³ç»“å¾ˆç´§ï¼Œæ‰‹æŒ‡èƒ½æ„Ÿè§‰åˆ°éº»ã€‚é—¨è¢«å…³ä¸Šåï¼Œå¤–é¢çš„å£°éŸ³å‡ ä¹å¬ä¸è§ï¼Œåªå‰©ä¸‹å¢™é‡Œå¶å°”ä¼ æ¥çš„ç»†å°éœ‡åŠ¨å£°ã€‚ç©ºæ°”é‡Œæœ‰å¥¶æ²¹ã€èœ¡å’Œä¸€ç‚¹å¡‘æ–™æ°”çƒçš„å‘³é“ï¼Œè®©äººä¸€æ—¶åˆ†ä¸æ¸…è¿™æ˜¯æƒŠå“è¿˜æ˜¯åº†ç¥ã€‚",
    },
    exam: {
      name: "ç§˜å¯†æˆ¿é—´ Â· è€ƒç ”èƒœåˆ©ï¼",
      desc: "é—¨æ‰“å¼€åï¼Œå…‰çº¿ä¸€ä¸‹å­å˜å¾—æ˜äº®è®¸å¤šã€‚æˆ¿é—´é‡Œæœ‰ä¸€å¼ ä¹¦æ¡Œå’Œä¸€æŠŠæ¤…å­ï¼Œå°ç¯å…³ç€ï¼Œæ¡Œé¢æ‘†ç€æœ¬å­å’Œå‡ å¼ çº¸ï¼Œä¸€å †èµ„æ–™æ—è¾¹è¿˜æœ‰å‡ æ¯é¥®æ–™ã€‚ç”šè‡³è¿˜æœ‰ä¸€ä¸ªè‹¹æœç¬”è®°æœ¬ã€‚",
    },
  }
};

const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

const GAME = {
  room: "hall",
  playerName: CONFIG.defaultPlayer,
  friendName: CONFIG.defaultFriend,
  inv: {},
  flags: {},
  log: [],
  progress: 0,
};
let IN_CUTSCENE = false; 
const ITEMS = {
  hall: [
    {
      id:"window", icon:"â„ï¸", name:"ç»“éœœçš„çª—",
      short:"çª—å¤–æ˜¯é›ªï¼Œçª—å†…æ˜¯ä½ ã€‚",
      desc:"ä½ å‡‘è¿‘ç»ç’ƒï¼Œéœœçº¹æŒ¡ä½äº†å¤§åŠè§†çº¿ã€‚çª—å¤–åªæœ‰é›ªå’Œé»‘è‰²æ ‘å½±ï¼Œé£å¹è¿‡æ—¶çª—æ¡†ä¼šè½»è½»æŠ–ä¸€ä¸‹ã€‚ç­‰ç­‰ï¼Œä¸ºä»€ä¹ˆæœ‰é»‘å½±åœ¨åŠ¨...?",
      actions: [{label:"è´´è¿‘æŸ¥çœ‹", run:()=>log("ä½ è´´è¿‘çª—æˆ·ï¼Œå†°å†·çš„éœœæ°”æ‰‘é¢è€Œæ¥ã€‚ä½†ä½ ä»€ä¹ˆéƒ½æ²¡æœ‰çœ‹è§")}],
    },
    {
      id:"sofa", icon:"ğŸ›‹ï¸", name:"æ—§æ²™å‘",
      short:"å¼¹ç°§å±å‘€ï¼Œåƒåœ¨ç¬‘ã€‚",
      desc:"æ²™å‘è¡¨é¢æœ‰äº›æ½®ï¼Œåå«è¾¹ç¼˜ç£¨å¾—å‘ç™½ã€‚ç¼éš™é‡Œå¡ç€å‡ ç²’å¹²æ‰çš„æ¾é’ˆå’Œä¸€å°æ®µå½©å¸¦ç¢å±‘ï¼Œåƒæ˜¯æœ‰äººåœ¨è¿™é‡Œåœç•™è¿‡ã€‚ä½ æŒ‰ä¸‹å»ï¼Œå¼¹ç°§å‘å‡ºå¾ˆè½»çš„å“å£°ã€‚",
      actions: [{label:"ç¿»æ‰¾åå«", run:()=>log("ä½ ç¿»å¼€åå«ï¼Œåªæœ‰é™ˆæ—§çš„å°˜å‘³ã€‚")}],
    },
    {
      id:"rug", icon:"ğŸ§¶", name:"èŠ±çº¹åœ°æ¯¯",
      short:"ä¸€å—å¯ç–‘çš„éš†èµ·ã€‚",
      desc:()=> GAME.flags.rugLifted
        ? "åœ°æ¯¯è¢«æ€å¼€åï¼Œæœ¨åœ°æ¿ä¸Šç•™ç€ä¸€é“æµ…æµ…çš„åˆ’ç—•ï¼Œè¾¹ç¼˜è¿˜æœ‰è¢«å‹å‡ºçš„å°å­ã€‚ä½ ç”¨æ‰‹æ‘¸äº†æ‘¸ï¼Œæœ¨çº¹é‡Œå¤¹ç€ç»†ç°ï¼Œåƒæ˜¯æœ‰ä»€ä¹ˆä¸œè¥¿å¸¸è¢«æ‹–åŠ¨æˆ–è—è¿‡ã€‚"
        : "åœ°æ¯¯è¾¹ç¼˜ç¿˜èµ·ä¸€ç‚¹ï¼Œåƒè¢«äººåŒ†å¿™æ€è¿‡åˆæ”¾å›å»ã€‚èŠ±çº¹é‡Œå¤¹ç€äº›ç»†é›ªå’Œç°å°˜ï¼Œé è¿‘éš†èµ·å¤„æ‘¸ä¸Šå»æœ‰ç¡¬ç‰©é¡¶ç€ï¼Œä½ç½®å¾ˆä¸è‡ªç„¶ã€‚",
      actions: ()=> {
        if(!GAME.flags.rugLifted){
          return [
            {label:"æ€å¼€åœ°æ¯¯", run:()=>{
              GAME.flags.rugLifted = true;
              give("prybar");
              log("ä½ æ€å¼€åœ°æ¯¯ï¼Œä¸‹é¢ç«Ÿå‹ç€ä¸€æ ¹æ’¬æ£ã€‚");
              msg("mainMsg","ä½ è·å¾—ï¼šæ’¬æ£ã€‚","good");
              render();
            }}
          ];
        }
        return [{label:"è§‚å¯Ÿåœ°æ¿åˆ’ç—•", run:()=>log("ä½ è¹²ä¸‹è§‚å¯Ÿåˆ’ç—•ï¼Œåƒæœ‰ä»€ä¹ˆé‡ç‰©æ›¾è¢«æ‹–åŠ¨ã€‚")}];
      }
    },
    {
      id:"drawer", icon:"ğŸ—„ï¸", name:"æŸœå­æŠ½å±‰",
      short:"å¡æ­»äº†ï¼Œåƒåœ¨æŠµæŠ—ã€‚",
      desc:()=> GAME.flags.drawerOpened
        ? "æŠ½å±‰å·²ç»è¢«æ’¬å¼€ã€‚\nçº¸æ¡æ•£å‘ç€...é¦™ç”œçš„æ°”æ¯?"
        : "æŠ½å±‰ç¼éš™é‡Œå¡æ»¡æœ¨å±‘ï¼Œä¼¼ä¹è¢«ç¡¬ç‰©å¡ä½ã€‚\nå“å½“å“å½“ï¼Œä½ æ‘‡æ™ƒäº†ä¸€ä¸‹ã€‚",
      actions: ()=> {
        if(GAME.flags.drawerOpened){
          return [{label:"å†æ£€æŸ¥ä¸€æ¬¡", run:()=>log("ä½ å†æ¬¡æ£€æŸ¥æŠ½å±‰ï¼Œæ²¡æœ‰æ–°çš„å‘ç°ã€‚")}];
        }
        if(has("prybar")){
          return [
            {label:"ç”¨æ’¬æ£æ’¬å¼€", run:()=>{
              GAME.flags.drawerOpened = true;
              give("note_code");
              log("ä½ ç”¨æ’¬æ£æ’¬å¼€æŠ½å±‰ï¼Œé‡Œé¢æœ‰ä¸€å¼ æŠ˜å¾—å¾ˆæ•´é½çš„çº¸æ¡ã€‚");
              msg("mainMsg","ä½ æ‰¾åˆ°ï¼šçº¸æ¡","good");
              render();
            }}
          ];
        }
        return [{label:"å¾’æ‰‹æ‹‰æ‰¯", run:()=>log("ä½ ç”¨åŠ›æ‹‰æ‰¯ï¼ŒæŠ½å±‰çº¹ä¸ä¸åŠ¨ã€‚ä¹Ÿè®¸éœ€è¦å·¥å…·ã€‚")}];
      }
    },
    {
      id:"painting", icon:"ğŸ–¼ï¸", name:"å¢™ä¸ŠæŒ‚ç”»",
      short:"ç”»æ¡†æ­ªäº†åŠå˜ç±³ã€‚",
      desc:()=> GAME.flags.paintingMoved
        ? "æŒ‚ç”»å·²è¢«ä½ ç§»å¼€ï¼Œåæ–¹éœ²å‡ºä¸€é“æš—æ ¼ã€‚ä½ å‡­å€Ÿç€ä¼ å¥‡è°ƒæŸ¥å‘˜çš„ä½“è´¨è§‰å¾—è¿™é‡Œæœ‰éšç§˜çš„æœºå…³"
        : "ä¸€å¹…æ—§ç”»ï¼šæ˜¯...ä¸€ä¸ªç†Ÿæ‚‰çš„ç”»åƒï¼Œä½ å¥½åƒåœ¨æœ‹å‹çš„è‘—ä½œã€Šæƒ…äººä¸‡å¹´ã€‹é‡Œè§è¿‡ä»–ã€‚\næœ‹å‹çš„è‘—ä½œå¾ˆç«ï¼Œè¿™ä½ çŸ¥é“ï¼Œä½†å‡ºç°åœ¨é›ªå¤œæ´‹æˆ¿é‡Œä¹Ÿå¤ªè¯¡å¼‚äº†å§ï¼ï¼Ÿ",
      actions: ()=> {
        if(!GAME.flags.paintingMoved){
          return [
            {label:"æŠŠç”»ç§»å¼€", run:()=>{
              GAME.flags.paintingMoved = true;
              log("ä½ æŠŠæŒ‚ç”»ç§»å¼€ï¼Œå¢™åç«Ÿè—ç€ä¸€ä¸ªå°å°çš„å¯†ç ç®±ã€‚");
              msg("mainMsg","æŒ‚ç”»åå‡ºç°ï¼šå¯†ç ç®±ã€‚","good");
              render();
            }},
            {label:"è½»æ•²ç”»æ¡†", run:()=>log("ä½ è½»æ•²ç”»æ¡†ï¼Œå›å£°ç©ºæ´ï¼Œåƒå¢™åæœ‰å¤¹å±‚ã€‚")}
          ];
        }
        return [{label:"æŸ¥çœ‹æš—æ ¼è¾¹ç¼˜", run:()=>log("ä½ æ‘¸åˆ°æš—æ ¼è¾¹ç¼˜çš„é‡‘å±å‡‰æ„ï¼ŒåƒæŸç§æœºå…³ã€‚")}];
      }
    },
    {
      id:"lockbox", icon:"ğŸ”’", name:"å¯†ç ç®±",
      short:"éœ€è¦4ä½æ•°å­—ã€‚",
      hidden: ()=> !GAME.flags.paintingMoved,
      desc:()=> GAME.flags.lockboxOpened
        ? "å¯†ç ç®±å·²ç»æ‰“å¼€ã€‚\nä¸€ä¸ªå¾ˆé‡å·¥çœ‹èµ·æ¥kpä¸ä¼šå…è®¸å‡ºç°åœ¨è¿™é‡Œçš„ä¸œè¥¿æ˜ å…¥ä½ çœ¼å¸˜ã€‚"
        : "ä¸€ä¸ªé‡‘å±å¯†ç ç®±ï¼Œè½¬ç›˜æ—æ²¾ç€å†·å‡çš„æ°´æ±½ã€‚\næœ‰ç€åå¤ç£¨æŸçš„ç—•è¿¹\n\næç¤ºï¼šè¾“å…¥ 4 ä½æ•°å­—ã€‚",
      actions: ()=> {
        if(GAME.flags.lockboxOpened){
          return [{label:"æŸ¥çœ‹ç©ºç®±", run:()=>log("ä½ æœ›ç€ç©ºç®±ï¼Œåƒæœ›ç€ä¸€æ®µå·²è¢«è§£å¼€çš„ç§˜å¯†ã€‚")}];
        }
        return [
          {label:"è¾“å…¥å¯†ç ", run:()=>openCodePrompt({
            title:"è¾“å…¥å¯†ç ï¼ˆ4ä½æ•°å­—ï¼‰",
            hint:"å°±åœ¨ä»Šå¤©",
            onSubmit:(code)=>{
              if(code === CONFIG.lockboxCode){
                GAME.flags.lockboxOpened = true;
                give("hammer");
                give("note_hint");
                log("å’”å“’â€”â€”å¯†ç ç®±å¼¹å¼€ã€‚é‡Œé¢æœ‰ä¸€æŠŠå°æ‰‹æªå’Œå¦ä¸€å¼ çº¸æ¡ã€‚");
                msg("mainMsg","å¯†ç æ­£ç¡®ï¼ä½ è·å¾—ï¼šå°æ‰‹æªã€çº¸æ¡æç¤ºã€‚","good");
                render();
                closeModal();
              }else{
                log("ä½ è¾“å…¥äº†å¯†ç ï¼Œä½†å¯†ç ç®±æ¯«æ— ååº”ã€‚");
                msg("mainMsg","å¯†ç ä¸å¯¹ã€‚å†æ‰¾æ‰¾çº¿ç´¢ã€‚","bad");
                shakeMsg();
              }
            }
          })}
        ];
      }
    },
    {
      id:"bookshelf", icon:"ğŸ“š", name:"ä¹¦æ¶",
      short:"æŸæœ¬ä¹¦çªå‡ºä¸€ç‚¹ã€‚",
      desc:"å¤©å•Šè¿™å°±æ˜¯ã€Šæƒ…äººä¸‡å¹´ã€‹é‡‘è£…ç‰ˆ+ä½œè€…ç­¾åï¼Œè¿˜æœ‰åˆ˜æ™¯å·çš„ç”»åƒã€‚",
      actions: [
        {label:"æŠ½å‡ºé‚£æœ¬çªå‡ºçš„ä¹¦", run:()=>{
          log("ä½ æŠ½å‡ºé‚£æœ¬ä¹¦ï¼Œç°å°˜åƒé›ªä¸€æ ·é£˜è½ã€‚ä½ å’³å—½äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰æœ‰ç‚¹åˆ»æ„ã€‚");
          msg("mainMsg","ä¸€å¼ çº¸æ¡é£˜è½ï¼šwzfèƒ½ä¸èƒ½å¿«ç‚¹ç»™æˆ‘åƒäº§å“é¥­...","good");
        }},
        {label:"æ‰«è§†ä¹¦è„Š", run:()=>log("ä½ æ‰«è§†ä¹¦è„Šï¼Œä¹¦ååƒä¸€ä¸²æ²‰é»˜çš„è¯è¯ã€‚")}
      ]
    },
    {
      id:"fireplace", icon:"ğŸ”¥", name:"å£ç‚‰",
      short:"ç°çƒ¬æ¸©åº¦ä¸å¯¹åŠ²ã€‚",
      desc:"ç«åƒæ˜¯åˆšè¢«ç†„ç­ï¼Œå®¢å…å†…æ¸©åº¦åœ¨ç¼“æ…¢çš„ä¸‹é™...ç­‰ç­‰...ä¸ºä»€ä¹ˆå£ç‚‰é‡Œä¼šæœ‰æ°”çƒç¢ç‰‡å•Šï¼",
      actions: [
        {label:"æ‹¨å¼€ç°çƒ¬", run:()=>log("ä½ æ‹¨å¼€ç°çƒ¬ï¼ŒæŒ‡å°–è§¦åˆ°ä¸€ä¸è¯¡å¼‚çš„æ¸©çƒ­ã€‚")},
        {label:"æŸ¥çœ‹å£ç‚‰å°é¢", run:()=>log("ä½ çœ‹è§å£ç‚‰å°é¢æœ‰è½»å¾®çš„åˆ®ç—•ï¼Œåƒè¢«ä»€ä¹ˆé”ç‰©åˆ’è¿‡ã€‚")}
      ]
    },
    {
      id:"vase", icon:"ğŸº", name:"æ¯«æ— ç ´ç»½çš„é“œç›’",
      short:"ç¡¬å¾—ä¸åˆå¸¸ç†",
      desc:()=> GAME.flags.vaseSmashed
        ? "ç›’å­å·²ç»ç¢æˆä¸€åœ°ã€‚\nä¸€ä¸ªé’¥åŒ™æ‰äº†å‡ºæ¥"
        : "ä¸å¤ªåƒæ™®é€šç›’å­ï¼Œå®ƒå¤ªç¡¬äº†ï¼Œæ‹’ç»äº†ä½ ç‰©ç†å­¦åœ£å‰‘çš„è®¿é—®ã€‚å®ƒéœ€è¦ä»¤kpæ›´ææƒ§çš„ä¸œè¥¿æ¥æ‰“å¼€ã€‚",
      actions: ()=> {
        if(GAME.flags.vaseSmashed){
          return [{label:"é¿å¼€ç¢ç‰‡", run:()=>log("ä½ å°å¿ƒç»•å¼€ç¢ç‰‡ï¼Œè„šæ­¥å£°åœ¨ç©ºæˆ¿é—´é‡Œå›å“ã€‚")}];
        }
        if(has("hammer")){
          return [
            {label:"ç”¨æ‰‹æªå‡»ç¢", run:()=>{
              GAME.flags.vaseSmashed = true;
              give("key1");
              log("ä½ æŠ¬æ‰‹ä¸€å‡»â€”â€”ç›’å­ç¢è£‚ï¼Œç‹¼è—‰ä¸­éœ²å‡ºä¸€æŠŠå¥‡æ€ªçš„é’¥åŒ™ã€‚");
              msg("mainMsg","ä½ è·å¾—ï¼šç¬¬ä¸€æŠŠé’¥åŒ™ï¼Œæˆ–è®¸é€šå‘æœªçŸ¥çš„ç©ºé—´ã€‚","good");
              render();
            }},
            {label:"è½»æ•²æµ‹è¯•", run:()=>log("ä½ è½»æ•²é“œç›’ï¼Œå£°éŸ³ç©ºè„†ï¼Œé‡Œé¢åƒè—ç€ç¡¬ç‰©ã€‚")}
          ];
        }
        return [{label:"å¾’æ‰‹æ‘‡æ™ƒ", run:()=>log("ä½ æ‘‡äº†æ‘‡ï¼Œé‡Œé¢ä¼¼ä¹æœ‰ä¸œè¥¿ï¼Œä½†ä»–è¢«æ”¹è£…çš„åƒå®¶1çš„pyï¼Œååˆ†åšå›ºä¸å¯ä¾µçŠ¯ã€‚")}];
      }
    },
    {
      id:"door_secret", icon:"ğŸšª", name:"é€šå¾€ç§˜å¯†æˆ¿é—´çš„é—¨",
      short:"é—¨ç¼é‡Œæ¼å‡ºä¸€ä¸å†·å…‰ã€‚",
      desc:()=> has("key1")
        ? "é—¨é”çœ‹èµ·æ¥èƒ½ç”¨é’¥åŒ™æ‰“å¼€ã€‚\né—¨èƒŒåä¼ æ¥ç»†ç»†ç°Œç°Œçš„å“å£°ã€‚"
        : "é—¨æŠŠæ‰‹å†°å†·ï¼Œé”å­”æ·±å¤„åƒä¸€åªçœ¼ç›ã€‚ä½ çœ‹äº†çœ‹ï¼Œæ²¡çœ‹è§ä»€ä¹ˆä¸œè¥¿\n\néœ€è¦ï¼šç¬¬ä¸€æŠŠé’¥åŒ™ã€‚",
      actions: ()=> {
        if(has("key1")){
          return [{label:"ç”¨ç¬¬ä¸€æŠŠé’¥åŒ™å¼€é—¨", run:()=>{
            log("ä½ æŠŠç¬¬ä¸€æŠŠé’¥åŒ™æ’å…¥é”å­”ã€‚");
            transitionToBirthday();
          }}];
        }
        return [{label:"è¯•ç€æ‹§åŠ¨", run:()=>log("é—¨çº¹ä¸ä¸åŠ¨ã€‚ä½ éœ€è¦é’¥åŒ™ã€‚")}];
      }
    },
    { id:"clock", icon:"ğŸ•°ï¸", name:"æŒ‚é’Ÿ", short:"ç§’é’ˆåœåœ¨æŸä¸€åˆ»ã€‚", desc:"æ»´ç­”æ»´ç­”ï¼Œåƒæ˜¯æŸ¯å—é‡Œæ‰æœ‰è€å¼æŒ‚é’Ÿï¼Œä½ æ‰“äº†ä¸ªå¯’æˆ˜ã€‚",
      actions:[{label:"è´´è¿‘å¬", run:()=>log("ä½ è´´è¿‘æŒ‚é’Ÿï¼Œå¬è§é½¿è½®å¡ä½çš„ç»†å“ã€‚")}]},
    { id:"cabinet", icon:"ğŸ§³", name:"æ‚ç‰©æŸœ", short:"ä¸Šé¢è½æ»¡ç°å°˜", desc:"æœ¨è´¨èŠ±çº¹å¾ˆå…¸é›…ï¼Œä½†å‘³é“æœ‰äº›ä¸å¦™ï¼Œä½ æœ‰äº›ä¸æƒ³é è¿‘å®ƒã€‚",
      actions:[{label:"æ‰“å¼€çœ‹çœ‹", run:()=>log("ä½ æ‰“å¼€æ‚ç‰©æŸœï¼šé‡Œé¢æ˜¯å‡ ä»¶éšæ„ä¸¢å¼ƒçš„ä½œæ¡ˆå·¥å…·ï¼šæ‰‹é“ï¼Œçš®é­ï¼Œå–‚è¿™éƒ½æ˜¯ä»€ä¹ˆå•Šï¼")}]},
  ],

  birthday: [
    {
      id:"chair", icon:"ğŸª‘", name:"æ¤…å­ä¸æŸç¼š",
      short:"ç»³ç»“å¾ˆä¸ä¸“ä¸šã€‚",
      desc:"ä½ è¢«ç»‘åœ¨æ¤…å­ä¸Šï¼Œèº«ä¸Šçš„å±é™©ç‰©å“è¢«æ²¡æ”¶ï¼Œä½ æƒ³ç€æ˜¯ä¸æ˜¯å¬·çš„äººå¤ªå¤šæœ‰äº†æŠ¥åº”ã€‚",
      actions:[
        {label:"æŒ£æ‰", run:()=>log("ä½ æŒ£æ‰äº†ä¸¤ä¸‹ï¼Œç»³ç»“è¢«ä½ æŒ£è„±å¼€äº†ã€‚")},
        {label:"è§‚å¯Ÿå‘¨å›´", run:()=>log("ä½ å¾ˆå†·é™ï¼Œå³ä½¿æœ‰æŠ¥åº”ä½ ä¹Ÿä¸ä¼šæ”¾å¼ƒå¬·ä½ å®¶0çš„ã€‚")}
      ]
    },
    {
      id:"decor", icon:"ğŸˆ", name:"è¯¡å¼‚çš„ç”Ÿæ—¥è£…é¥°",
      short:"å½©å¸¦ä¹±ä¸ƒå…«ç³Ÿ",
      desc:"å¤§å®¶é€çš„ç¤¼ç‰©éƒ½ä¹±ä¹±åœ°æ‘†æ”¾åœ¨æ¡Œå­ä¸Šï¼Œä½†wzfçˆ±å¥½çš„å¤šæ ·æ€§è®©æ¡Œå­æ··ä¹±çš„ä¸å¿ç›´è§†ã€‚",
      actions:[{label:"æ£€æŸ¥å½©å¸¦", run:()=>log("ä½ å‘ç°å½©å¸¦ä¸Šå†™ç€å°å­—ï¼šæˆ‘æƒ³çœ‹ä½ äº§å“ã€‚")}]
    },
    {
      id:"friends", icon:"ğŸ˜ˆ", name:"â€œå‡¶ç¥æ¶ç…â€çš„äººå½±",
      short:"å¥¹ä»¬åœ¨çœ‹ç€ä½ ã€‚",
      desc:"ä½ å¬åˆ°é—¨åä¼ æ¥ä¹±ä¸ƒå…«ç³Ÿçš„è¯´è¯å£°ã€‚\nã€â€œæˆ‘ä»¬è¦ä¸è¦è®©å¥¹å†™å®Œåç¯‡äº§å“æ–‡å†æ”¾å‡ºæ¥ï¼Ÿâ€ã€‘",
      actions:[{label:"æŠ¬å¤´ç›´è§†", run:()=>log("ä½ æŠ¬å¤´æ€’è§†ä»–ä»¬ï¼Œå‡ ä¸ªäººå½±å“§æºœä¸€ä¸‹æ¶ˆå¤±äº†ã€‚")}]
    },
    {
      id:"cake", icon:"ğŸ°", name:"è›‹ç³•",
      short:"ç”œå‘³åœ¨ç©ºæ°”é‡Œã€‚",
      desc:"æ„Ÿè§‰åƒä¸€ä¸ªå·¨å¤§çš„é™·é˜±ï¼Œä¸Šé¢æ’æ»¡äº†å¤§å®¶ç”»çš„è´ºå›¾ï¼Œç”šè‡³æœ€ä¸ä¼šç”»ç”»çš„wzfä¹Ÿæ­ªæ­ªæ‰­æ‰­ç”»äº†ä¸€åªå¤§ç»µç¾Šã€‚",
      actions: ()=> {
        if(has("key2")) return [{label:"æ‹¿èµ·å‰å­", run:()=>log("ä½ å·²ç»æ‹¿åˆ°ç¬¬äºŒæŠŠé’¥åŒ™ï¼Œè›‹ç³•æˆäº†çº¯ç²¹çš„å¿«ä¹ã€‚")}];
        return [
          {label:"åˆ‡å¼€è›‹ç³•", run:()=>{
            give("key2");
            log("ä½ åˆ‡å¼€è›‹ç³•ï¼Œé‡Œé¢ç«Ÿè—ç€ç¬¬äºŒæŠŠé’¥åŒ™ã€‚");
            msg("mainMsg","ä½ è·å¾—ï¼šç¬¬äºŒæŠŠé’¥åŒ™ã€‚å’‹è¿˜æœ‰æ´»..ä½ æ— è¯­åœ°æƒ³ã€‚","good");
            render();
          }}
        ];
      }
    },
    {
      id:"door_exam", icon:"ğŸšª", name:"é€šå¾€ç¬¬äºŒä¸ªç§˜å¯†æˆ¿é—´çš„é—¨",
      short:"é—¨åæ„Ÿè§‰æœ‰é˜´è°‹ã€‚",
      desc:()=> has("key2")
        ? "é”å­”æ­£åœ¨ç­‰å¾…ç¬¬äºŒæŠŠé’¥åŒ™ã€‚"
        : "é—¨è¢«åé”ã€‚\néœ€è¦ï¼šç¬¬äºŒæŠŠé’¥åŒ™ã€‚",
      actions: ()=> has("key2")
        ? [{label:"ç”¨ç¬¬äºŒæŠŠé’¥åŒ™å¼€é—¨", run:()=>{ log("ä½ æ¡ç´§ç¬¬äºŒæŠŠé’¥åŒ™ï¼Œèµ°å‘æœ€åçš„æˆ¿é—´ã€‚"); GAME.room="exam"; GAME.progress=92; render(); }}]
        : [{label:"æ¨é—¨", run:()=>log("é—¨ä¸åŠ¨ã€‚ä½ éœ€è¦ç¬¬äºŒæŠŠé’¥åŒ™ã€‚")}]
    }
  ],

  exam: [
    {
      id:"desk", icon:"ğŸ“", name:"æ¡Œé¢ä¸ç¬”è®°",
      short:"å­—è¿¹åƒæˆ˜æ–—ç—•è¿¹ã€‚",
      desc:"wzfåœ¨è¿™é‡Œç»™æ‰€æœ‰è€ƒç ”çš„æœ‹å‹ä»¬éƒ½ç•™äº†ç¥ç¦ã€‚",
      actions:[{label:"ç¿»ç¿»ä¾¿ç­¾", run:()=>log("ä¾¿ç­¾é‡Œå¤¹ç€å¯¿å¸éƒå°æœ¨èˆ¹æµ·åº•æé¤å…çš„ä¼˜æƒ åˆ¸ï¼Œé¥¿è´§æ¥è¢­ã€‚")}]
    },
    {
      id:"lamp", icon:"ğŸ’¡", name:"å°ç¯",
      short:"ç†„ç­ç€ï¼Œä½†ç¯æ³¡æœ‰ç‚¹çƒ«",
      desc:"ä½ çš„æœ‹å‹è€æ—¥å¯¹ç¯æ³¡åŠ¨äº†ç‚¹æ‰‹è„šã€‚",
      actions:[{label:"ç‚¹äº®", run:()=>log("ç¯å…‰äº®èµ·ï¼Œé˜´å½±é€€åä¸€æ­¥ã€‚ä¸çŸ¥é“å¯åŠ¨äº†ä»€ä¹ˆå¼€å…³ï¼Œç¯æ³¡å¼€å§‹å”±ä¿„ç½—æ–¯å°å—å¨˜å’Œåˆ€é©¬åˆ€é©¬ã€‚")}]
    },
    {
      id:"letter", icon:"ğŸ“¨", name:"ç”µè„‘",
      short:"çœ‹ç€çœ¼ç†Ÿã€‚",
      desc:"ä½ æœ‰ç§ä¸å¥½çš„é¢„æ„Ÿã€‚",
      actions:[{label:"å¯åŠ¨ç”µè„‘", run:()=>{ log("ä½ å°±çŸ¥é“ï¼Œä¸œæµ·ç»™ä½ æš‚åœåœ¨äº†ç‹æ ¼æ—äºŒé˜¶æ®µï¼Œè¿˜ç»™ä½ å¼€äº†ä¸€ä¸ªtxtæ ‡ä¸Šäº†é”®ä½ã€‚"); showEndingModal(); }}]
    },
    {
      id:"trophy", icon:"ğŸ†", name:"çµé­‚å¤§å¸ˆå½¢çŠ¶çš„å¥–æ¯",
      short:"æœ‰ç‚¹èŒèŒ",
      desc:"ä½œè€…å†™åˆ°è¿™å·²ç»çˆ±ä¸Šçµé­‚å¤§å¸ˆäº†ã€‚æœ‰äººæ‡‚å—ã€‚",
      actions:[{label:"æ‘¸ä¸€æ‘¸", run:()=>log("ä½ æ‰äº†ä¸¤æ»´è¡€...ä¸ºä»€ä¹ˆæ˜¯ä¸¤æ»´ï¼")}]
    },
  ],

  inv: {
    prybar: {name:"æ’¬æ£", desc:"ä¸€æ ¹ç”Ÿé”ˆçš„æ’¬æ£ï¼Œä¼ å¥‡ç‰©ç†å­¦åœ£å‰‘ã€‚ä½ æ„Ÿåˆ°å¾ˆå¥‡æ€ªï¼Œä½†ä½ è¿˜æ˜¯æ‹¿ä¸Šäº†å®ƒã€‚"},
    note_code: {name:"çº¸æ¡1", desc:()=>(
`çº¸æ¡ä¸Šå†™ç€ï¼šå¯¹ä½ é‡è¦çš„æ—¥æœŸã€‚`
    )},
    note_hint: {name:"çº¸æ¡2", desc:()=>(
`å¦ä¸€å¼ çº¸æ¡ï¼š\nä¸Šé¢ç¤ºæ„ä½ è¦ç ¸å¼€é‚£ä¸ªé“œç›’ã€‚`
    )},
    hammer: {name:"æ‰‹æª", desc:"è¿™ä¸æ˜¯kpä¹æ„çœ‹åˆ°çš„ä¸œè¥¿\n...ä½†ååˆ†æœ‰ç”¨!"},
    key1: {name:"ç¬¬ä¸€æŠŠé’¥åŒ™", desc:()=>(
`ç¬¬ä¸€æŠŠé’¥åŒ™ï¼š${CONFIG.key1Shape}\nä¸ç®¡æ€ä¹ˆè¯´å…ˆå‰è¿›è¯•è¯•ã€‚`
    )},
    key2: {name:"ç¬¬äºŒæŠŠé’¥åŒ™", desc:()=>(
`ç¬¬äºŒæŠŠé’¥åŒ™ï¼š${CONFIG.key2Shape}\nä½ ä¸ç¦å¥½å¥‡è¿˜èƒ½æ•´å‡ºä»€ä¹ˆæ´»å„¿ã€‚`
    )},
  }
};

// ---------- UI helpers ----------
function msg(id, text, type){
  const el = $("#"+id);
  el.textContent = text;
  el.classList.remove("good","bad","show");
  if(type) el.classList.add(type);
  el.classList.add("show");
}
function clearMsg(id){
  const el = $("#"+id);
  el.classList.remove("show","good","bad");
  el.textContent="";
}
function shakeMsg(){
  const el = $("#mainMsg");
  el.style.transform="translateX(-2px)";
  setTimeout(()=>el.style.transform="translateX(2px)",60);
  setTimeout(()=>el.style.transform="",120);
}
function log(text){
  const t = `[${new Date().toLocaleTimeString()}] ${text}`;
  GAME.log.unshift(t);
  renderLog();
  autoProgress();
}
function autoProgress(){
  let p = 0;
  if(GAME.room === "hall") p = 15;
  if(GAME.flags.rugLifted) p = 25;
  if(GAME.flags.drawerOpened) p = 35;
  if(GAME.flags.paintingMoved) p = 45;
  if(GAME.flags.lockboxOpened) p = 60;
  if(GAME.flags.vaseSmashed) p = 75;
  if(GAME.room === "birthday") p = Math.max(p, 82);
  if(has("key2")) p = Math.max(p, 88);
  if(GAME.room === "exam") p = Math.max(p, 100);
  GAME.progress = Math.max(GAME.progress, p);
}
function setProgressUI(){
  const pct = Math.max(0, Math.min(100, GAME.progress));
  $("#barFill").style.width = pct + "%";
  $("#progressText").textContent = pct + "%";
  $("#barLabel").textContent = pct < 100 ? "è°ƒæŸ¥è¿›è¡Œä¸­â€¦" : "å·²å®Œæˆ âœ…";
}
function has(id){ return !!GAME.inv[id]; }
function give(id){
  GAME.inv[id] = true;
  renderInv();
}

function renderInv(){
  const list = $("#invList");
  const ids = Object.keys(GAME.inv);
  if(ids.length === 0){
    list.innerHTML = `<div class="mono">ï¼ˆç©ºï¼‰\nèƒŒåŒ…ç©ºç©ºçš„ï¼Œå¿ƒå†·å†·çš„</div>`;
    return;
  }
  list.innerHTML = ids.map(id=>{
    const item = ITEMS.inv[id];
    return `
      <div class="invItem" data-inv="${id}">
        <b>${item?.name ?? id}</b>
        <div class="meta">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
      </div>
    `;
  }).join("");
  $$(".invItem").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.dataset.inv;
      openItemModal(id);
    });
  });
}

function renderLog(){
  $("#logBox").textContent = GAME.log.slice(0, 40).join("\n") || "ï¼ˆæš‚æ— ï¼‰\nã€åœ¨è¿™é‡Œå†™ï¼šä½ æƒ³è¦çš„æ—¥å¿—å¼€å¤´ã€‘";
}

// ---------- Modal ----------
function openModal({title, body, actions, input=false, inputHint="", inputPlaceholder="åœ¨æ­¤è¾“å…¥â€¦"}){
  $("#modalTitle").textContent = title;
  $("#modalBody").innerHTML = body;
  $("#modalActions").innerHTML = "";
  $("#modalInputWrap").style.display = input ? "block" : "none";
  $("#modalInputHint").textContent = inputHint || "";
  $("#modalInput").value = "";
  $("#modalInput").placeholder = inputPlaceholder;

  (actions || []).forEach(a=>{
    const btn = document.createElement("button");
    btn.textContent = a.label;
    btn.className = a.secondary ? "secondary" : "";
    btn.onclick = a.run;
    $("#modalActions").appendChild(btn);
  });

  $("#modalMask").classList.add("show");
  $("#modalMask").setAttribute("aria-hidden","false");
}
function closeModal(){
  $("#modalMask").classList.remove("show");
  $("#modalMask").setAttribute("aria-hidden","true");
}
$("#modalClose").addEventListener("click", ()=>{
  if(IN_CUTSCENE) return;
  closeModal();
});

$("#modalMask").addEventListener("click", (e)=>{
  if(IN_CUTSCENE) return;
  if(e.target.id==="modalMask") closeModal();
});

function openCodePrompt({title, hint, onSubmit}){
  openModal({
    title,
    body:`<div>è¯·è¾“å…¥å¯†ç ï¼š</div><div class="hint">${hint}</div>`,
    input:true,
    inputHint:"æ ¼å¼å»ºè®®ï¼š4ä½æ•°å­—ã€‚",
    inputPlaceholder:"å¾ˆæ˜æ˜¾",
    actions:[
      {label:"ç¡®è®¤", run:()=>{
        const code = $("#modalInput").value.trim();
        onSubmit(code);
      }},
      {label:"å–æ¶ˆ", secondary:true, run:closeModal}
    ]
  });
  setTimeout(()=>$("#modalInput").focus(), 50);
}

function openItemModal(invId){
  const it = ITEMS.inv[invId];
  const title = it?.name ?? invId;
  const desc = (typeof it.desc === "function") ? it.desc() : (it.desc ?? "");
  openModal({
    title,
    body:`<div class="mono">${escapeHTML(desc)}</div>`,
    actions:[{label:"å…³é—­", secondary:true, run:closeModal}]
  });
}

function escapeHTML(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

// ---------- Room rendering ----------
function roomItems(){
  const arr = ITEMS[GAME.room] || [];
  return arr.filter(it=> !(typeof it.hidden==="function" ? it.hidden() : it.hidden));
}

function openRoomItem(itemId){
  const it = roomItems().find(x=>x.id===itemId);
  if(!it) return;

  const desc = (typeof it.desc==="function") ? it.desc() : it.desc;
  const actions = (typeof it.actions==="function") ? it.actions() : (it.actions || []);
  openModal({
    title: it.name,
    body: `<div class="mono">${escapeHTML(desc || "")}</div>`,
    actions: [
      ...actions.map(a=>({label:a.label, run:()=>{ a.run(); }})),
      
    ]
  });
}

function renderRoom(){
  const room = CONFIG.rooms[GAME.room];
  $("#roomName").textContent = room?.name || GAME.room;
  $("#roomDesc").textContent = room?.desc || "";

  const grid = $("#itemsGrid");
  const items = roomItems();
  grid.innerHTML = items.map(it=>`
      <div class="item" data-item="${it.id}">
        <div class="icon">${it.icon || "?"}</div>
        <div>
          <b>${it.name}</b>
          <div class="meta">${it.short || ""}</div>
          ${it.hidden ? "" : `<div class="tag">å¯äº’åŠ¨</div>`}
        </div>
      </div>
  `).join("");

  $$(".item").forEach(el=>{
    el.addEventListener("click", ()=>openRoomItem(el.dataset.item));
  });

  $("#hintBox").innerHTML = CONFIG.hints[GAME.room] || "ã€åœ¨è¿™é‡Œå†™ï¼šä½ æƒ³æ˜¾ç¤ºçš„æç¤ºã€‘";
}

function renderHeader(){
  document.title = CONFIG.title;
  $("#gameTitle").textContent = "æš´é›ªä¸­ï¼Œä¸€åº§å·¨å¤§çš„å»ºç­‘é™é™çš„çŸ—ç«‹åœ¨ä½ é¢å‰ï¼Œè€Œä½ å¾¡å¯’çš„åªæœ‰æ€€é‡Œçš„...é¥ºå­?";
  $("#gameSubtitle").textContent = CONFIG.subtitle;
}

function renderNames(){
  const p = $("#playerName");
  if(p) p.value = GAME.playerName || CONFIG.defaultPlayer;
}

function render(){
  renderHeader();
  renderNames();
  renderRoom();
  renderInv();
  renderLog();
  autoProgress();
  setProgressUI();
}

// ---------- Cutscenes ----------
function transitionToBirthday(){
  closeModal();
  GAME.room = "birthday";
  GAME.progress = Math.max(GAME.progress, 80);
  IN_CUTSCENE = true;
  render();  

  const lines = CONFIG.cutsceneToBirthday.slice();
  let idx = 0;

  function next(){
    if(idx >= lines.length){
      IN_CUTSCENE = false;
      closeModal();
      openModal({
        title:"ç¥ä½ ç”Ÿæ—¥å¿«ä¹å‘€ç”Ÿæ—¥å¿«ä¹ï¼ï¼",
        body:`<div class="mono">${escapeHTML(CONFIG.birthdayBlessing(GAME.friendName))}</div>`,
        actions:[{label:"ç»§ç»­ï¼ˆå»æ‹¿ç¬¬äºŒæŠŠé’¥åŒ™ï¼‰", run:()=>{ closeModal(); render(); }}]
      });
      render();
      return;
    }

    openModal({
      title:`å‰§æƒ…æ¨è¿›ï¼ˆ${idx+1}/${lines.length}ï¼‰`,
      body:`<div class="mono">${escapeHTML(lines[idx])}</div>`,
      actions:[
        {label:"ç»§ç»­", run:()=>{ idx++; next(); }},
        {label:"è·³è¿‡å‰§æƒ…", secondary:true, run:()=>{ idx = lines.length; next(); }},
      ]
    });
  }
  next();
}

// ---------- Ending ----------
function launchConfetti(){
  const box = $("#confetti");
  box.innerHTML = "";
  const emojis = ["âœ¨","ğŸ‰","ğŸŒŸ","ğŸ’«","ğŸˆ","ğŸ€","ğŸª„","ğŸ†"];
  const n = 50;
  for(let i=0;i<n;i++){
    const s = document.createElement("span");
    s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    s.style.left = Math.random()*100 + "%";
    s.style.animationDuration = (3 + Math.random()*2.8) + "s";
    s.style.animationDelay = (Math.random()*0.6) + "s";
    s.style.fontSize = (14 + Math.random()*18) + "px";
    box.appendChild(s);
  }
  box.classList.add("show");
  setTimeout(()=>box.classList.remove("show"), 5200);
}

function showEndingModal(){
  launchConfetti();
  const text = CONFIG.examBlessing(GAME.friendName);
  openModal({
    title:"ä½ ç†è§£å®Œä¸œæµ·çš„é”®ä½ï¼Œå‡†å¤‡ç»§ç»­æ‰“æ´æ´éª‘å£«...åœ¨è‹¦æˆ˜ç‹æ ¼æ—çš„æ—¶å€™æœ‰ä¸€ä¸ªå¼¹çª—è·³å‡ºï¼Œæ‰“æ–­äº†ä½ çš„å›è¡€è¿‡ç¨‹ã€‚",
    body:`<div class="mono">${escapeHTML(text)}</div>
          <div class="hint">ä½ å¯ä»¥å¤åˆ¶è¿™è¡Œå­—å„¿ç»™å’©è€å¸ˆå‘è¿‡å»ï¼ˆå’©è€å¸ˆæœ¬äººå¯ä»¥å½“åšæ²¡çœ‹åˆ°ï¼ï¼ˆç›®ç§»ï¼‰ï¼‰ã€‚</div>`,
    actions:[
      {label:"å¤åˆ¶ç¥ç¦", run:async ()=>{
        try{
          await navigator.clipboard.writeText(text);
          msg("mainMsg","å¤åˆ¶æˆåŠŸå–µ","good");
        }catch(e){
          msg("mainMsg","å¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰ã€‚ä½ å¯ä»¥æ‰‹åŠ¨é€‰ä¸­å¤åˆ¶ã€‚","bad");
        }
      }},
      {label:"å…³é—­", secondary:true, run:closeModal},
    ]
  });
}

// ---------- Reset ----------
function reset(){
  IN_CUTSCENE = false;
  GAME.room = "hall";
  GAME.playerName = CONFIG.defaultPlayer;
  GAME.friendName = CONFIG.defaultFriend;
  GAME.inv = {};
  GAME.flags = {};
  GAME.log = [];
  GAME.progress = 0;
  clearMsg("mainMsg");

  // ä»ç¬¬ä¸€é¡µï¼ˆgame.htmlï¼‰å¸¦å…¥è°ƒæŸ¥å‘˜åå­—ï¼šlocalStorage["snow_mansion_prefill"]
  try{
    const prefill = JSON.parse(localStorage.getItem("snow_mansion_prefill") || "null");
    if(prefill?.playerName) GAME.playerName = prefill.playerName;
  }catch(e){}

  log("æ–°è°ƒæŸ¥å¼€å§‹ï¼šä½ è¸å…¥é›ªä¸­æ´‹æˆ¿ã€‚");
  render();
}

// ---------- Buttons ----------
$("#btnNew").addEventListener("click", ()=>{ reset(); });

// init
reset();
</script>
</body>
</html>
